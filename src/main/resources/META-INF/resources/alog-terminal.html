<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALog Terminal</title>
    <script>
        function getContextPath() {
            const fullPath = window.location.pathname;
            const terminalIndex = fullPath.indexOf('/alog-terminal.html');
            return terminalIndex > 0 ? fullPath.substring(0, terminalIndex) : '';
        }

        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const contextPath = getContextPath();
            return `${protocol}//${host}${contextPath}/alog-ws`;
        }

        window.APP_CONFIG = {
            socketUrl: getWebSocketUrl(),
            contextPath: getContextPath()
        };
    </script>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            padding: 20px;
            margin: 0;
        }
        #terminal {
            height: 80vh;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        #input-line {
            display: flex;
        }
        #prompt {
            margin-right: 5px;
        }
        #command-input {
            background: transparent;
            border: none;
            color: #0f0;
            font-family: monospace;
            flex-grow: 1;
            outline: none;
        }
    </style>
</head>
<body>
<div id="terminal"></div>
<div id="input-line">
    <span id="prompt">$</span>
    <input type="text" id="command-input" autofocus>
</div>

<script>
    const terminal = document.getElementById('terminal');
    const commandInput = document.getElementById('command-input');
    const promptElement = document.getElementById('prompt');

    let socket = null;
    let userId = 'alog';
    let commandHistory = [];
    let historyIndex = -1;
    let currentCommand = '';

    const appendToTerminal = (text) => {
        terminal.innerHTML += text + '\n';
        terminal.scrollTop = terminal.scrollHeight;
    };

    const clearTerminal = () => {
        terminal.innerHTML = '';
    };

    function updatePrompt(connected = false) {
        promptElement.textContent = connected ? `${userId}>` : '$';
    }

    function connectSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            appendToTerminal('å·²è¿æ¥ï¼Œå‹¿é‡å¤è¿æ¥ã€‚');
            return;
        }

        socket = new WebSocket(window.APP_CONFIG.socketUrl);

        socket.onopen = () => {
            appendToTerminal('âœ… WebSocket å·²è¿æ¥');
            updatePrompt(true);
        };
        socket.onmessage = (e) => appendToTerminal(e.data);
        socket.onerror = (e) => appendToTerminal(`âŒ WebSocket é”™è¯¯: ${e.type}`);
        socket.onclose = () => {
            appendToTerminal('ğŸ”Œ WebSocket å·²æ–­å¼€');
            updatePrompt(false);
        };
    }

    function disconnectSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
            appendToTerminal('ğŸ”Œ è¿æ¥å·²å…³é—­');
        } else {
            appendToTerminal('å°šæœªè¿æ¥æˆ–å·²æ–­å¼€ã€‚');
        }
    }

    function addToHistory(command) {
        if (command && (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== command)) {
            commandHistory.push(command);
            if (commandHistory.length > 50) {
                commandHistory.shift();
            }
        }
        historyIndex = commandHistory.length;
    }

    function navigateHistory(direction) {
        if (commandHistory.length === 0) return;

        if (direction === 'up' && historyIndex > 0) {
            historyIndex--;
        } else if (direction === 'down' && historyIndex < commandHistory.length - 1) {
            historyIndex++;
        } else if (direction === 'down' && historyIndex === commandHistory.length - 1) {
            historyIndex++;
            commandInput.value = currentCommand;
            return;
        }

        commandInput.value = commandHistory[historyIndex] || '';
        setTimeout(() => {
            commandInput.selectionStart = commandInput.selectionEnd = commandInput.value.length;
        }, 0);
    }

    function showHelp() {
        appendToTerminal("ALog Terminal å‘½ä»¤å¸®åŠ©:");
        appendToTerminal("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        appendToTerminal("â”‚  connect                                     è¿æ¥ WebSocket æœåŠ¡å™¨                     â”‚");
        appendToTerminal("â”‚  exit/quit                                   æ–­å¼€ WebSocket è¿æ¥                       â”‚");
        appendToTerminal("â”‚  clear                                       æ¸…ç©ºç»ˆç«¯å±å¹•                               â”‚");
        appendToTerminal("â”‚  help                                        æ˜¾ç¤ºæœ¬å¸®åŠ©ä¿¡æ¯                             â”‚");
        appendToTerminal("â”‚  ls [path]                                   åˆ—å‡ºAPIæ¥å£,æ”¯æŒæ¨¡ç³Šæœç´¢                    â”‚");
        appendToTerminal("â”‚  monitor [path] [param | result | time]      ç›‘æ§æŒ‡å®šAPIæ¥å£                            â”‚");
        appendToTerminal("â”‚                                              ç¤ºä¾‹: monitor /api/v1/user param,time     â”‚");
        appendToTerminal("â”‚  remove [path]                               ç§»é™¤å¯¹æŒ‡å®šAPIæ¥å£çš„ç›‘æ§                     â”‚");
        appendToTerminal("â”‚                                              ç¤ºä¾‹: remove /api/v1/user                 â”‚");
        appendToTerminal("â”‚  clearall                                    æ¸…ç©ºå…¨éƒ¨ç›‘æ§çš„APIæ¥å£                       â”‚");
        appendToTerminal("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        appendToTerminal("æç¤ºï¼šä½¿ç”¨ â†‘/â†“ ç®­å¤´é”®æµè§ˆå†å²å‘½ä»¤");
    }

    // æ–°å¢ç„¦ç‚¹äº‹ä»¶å¤„ç†
    commandInput.addEventListener('focus', () => {
        historyIndex = commandHistory.length;
        currentCommand = commandInput.value;
    });

    commandInput.addEventListener('blur', () => {
        currentCommand = commandInput.value;
    });

    // ç›‘å¬è¾“å…¥æ¡†
    commandInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const input = commandInput.value.trim();
            commandInput.value = '';

            if (!input) return;

            appendToTerminal(`${promptElement.textContent} ${input}`);
            addToHistory(input);
            currentCommand = '';

            switch (input.toLowerCase()) {
                case 'connect':
                    connectSocket();
                    break;
                case 'exit':
                case 'quit':
                    disconnectSocket();
                    break;
                case 'clear':
                    clearTerminal();
                    break;
                case 'help':
                    showHelp();
                    break;
                default:
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(input);
                    } else {
                        appendToTerminal('âš ï¸ æœªè¿æ¥ WebSocketï¼Œè¾“å…¥ `connect` è¿æ¥ã€‚');
                    }
            }
        } else if (e.ctrlKey && e.key === 'd') {
            appendToTerminal('é€€å‡ºè¿æ¥ï¼ˆCtrl+Dï¼‰');
            disconnectSocket();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex === commandHistory.length) {
                currentCommand = commandInput.value;
            }
            navigateHistory('up');
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateHistory('down');
        }
    });

    // åˆå§‹æç¤º
    appendToTerminal("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    appendToTerminal("â”‚   æ¬¢è¿ä½¿ç”¨ ALog Terminal    â”‚");
    appendToTerminal("â”‚        ä½œè€…: chenenwei      â”‚");
    appendToTerminal("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    appendToTerminal("è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤");
</script>
</body>
</html>